#!/bin/bash

# Validate branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
if [[ ! $BRANCH_NAME =~ ^(main|ft/|tt/|rf/|cr/|wr/|fx/|hf/|dc/|ts|ch/) ]]; then
  echo "Invalid branch name: $BRANCH_NAME"
  exit 1
fi

# Validate latest commit message
COMMIT_MSG=$(git log --pretty=format:%s -1)
if [[ ! $COMMIT_MSG =~ ^\[(ft|tt|rf|cr|wr|fx|hf|dc|ts|ch)\]\[GG-[0-9]{3}\]\ .+ ]]; then
  echo "Invalid commit message: $COMMIT_MSG"
  exit 1
fi

# Dart format check
changed_files=$(dart format --set-exit-if-changed .)
status=$?
if [ $status -ne 0 ]; then
  echo "Dart files need formatting. Please run 'dart format .' before pushing."
  echo "$changed_files"
  exit 1
fi

# Flutter analyze check
echo "Running flutter analyze before push..."
flutter analyze
RESULT=$?
if [ $RESULT -ne 0 ]; then
  echo "Push rejected: flutter analyze failed."
  exit 1
fi
